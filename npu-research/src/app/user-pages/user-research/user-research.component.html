<div class="bg-gray-100 min-h-screen p-6 text-2xl">
  <!-- ===== SEARCH ===== -->
  <div class="max-w-7xl mx-auto bg-white p-6">
    <!-- Title -->
    <div class="flex flex-col justify-center items-center text-center">
      <div
        class="w-24 h-24 rounded-full bg-linear-to-b from-sky-200 to-sky-100 flex items-center justify-center mb-4"
      >
        <i class="bi bi-search text-4xl text-gray-700"></i>
      </div>
      <h1 class="text-3xl font-bold text-gray-700">ค้นหาข้อมูลงานวิจัย</h1>
    </div>

    <div class="mx-w-full mx-auto mt-10 mb-6">
      <!-- === ตัวกรอง === -->
      <div class="grid grid-cols-12 gap-3 items-center">

        <!-- ===== label ===== -->
        <label class="col-span-12 md:col-span-2 text-3xl font-black text-gray-700">
          ตัวกรอง
        </label>
      
        <!-- ===== เลือกประเภทผลงาน ===== -->
        <div class="col-span-12 md:col-span-5 relative">
          <button
            type="button"
            (click)="toggleDropdown('type', $event)"
            class="w-full h-11 border rounded-full px-6 flex justify-between items-center bg-white"
          >
            <span class="truncate">
              {{ displaySelectedType() }}
            </span>
            <i class="bi bi-chevron-down"></i>
          </button>
      
          <!-- dropdown type -->
          <div
            *ngIf="isOpen('type')"
            class="absolute z-50 w-full bg-white border rounded-md mt-1 shadow"
            (click)="$event.stopPropagation()"
          >
            <input
              [(ngModel)]="searchType"
              placeholder="ค้นหา..."
              class="w-full px-3 py-2 border-b outline-none"
            />
            <ul class="max-h-48 overflow-y-auto">
              <li
                *ngFor="let t of filteredType()"
                (click)="selectType(t)"
                class="px-4 py-2 cursor-pointer hover:bg-gray-100"
              >
                {{ t }}
              </li>
            </ul>
          </div>
      
          <!-- dropdown subtype -->
          <div
            *ngIf="selectedType && subTypeMap[selectedType].length > 0 && isOpen('subType')"
            class="absolute z-40 w-full bg-white border rounded-md mt-1 shadow"
            (click)="$event.stopPropagation()"
          >
            <input
              [(ngModel)]="searchSubType"
              placeholder="ค้นหา..."
              class="w-full px-3 py-2 border-b outline-none"
            />
            <ul class="max-h-48 overflow-y-auto">
              <li
                *ngFor="let st of filteredSubType()"
                (click)="selectSubType(st)"
                class="px-4 py-2 cursor-pointer hover:bg-gray-100"
              >
                {{ st }}
              </li>
            </ul>
          </div>
        </div>
      
        <!-- ===== เลือกหน่วยงาน ===== -->
        <div class="col-span-12 md:col-span-5 relative">
          <button
            type="button"
            (click)="toggleDropdown('agency', $event)"
            class="w-full h-11 border rounded-full px-6 flex justify-between items-center bg-white"
          >
            <span class="truncate">
              {{ selectedAgency || 'เลือกหน่วยงาน' }}
            </span>
            <i class="bi bi-chevron-down"></i>
          </button>
      
          <div
            *ngIf="isOpen('agency')"
            class="absolute z-50 w-full bg-white border rounded-md mt-1 shadow"
            (click)="$event.stopPropagation()"
          >
            <input
              [(ngModel)]="searchAgency"
              placeholder="ค้นหา..."
              class="w-full px-3 py-2 border-b outline-none"
            />
            <ul class="max-h-48 overflow-y-auto">
              <li
                *ngFor="let a of filteredAgency()"
                (click)="selectAgency(a)"
                class="px-4 py-2 hover:bg-yellow-50 cursor-pointer"
              >
                {{ a }}
              </li>
            </ul>
          </div>
        </div>
      
      </div>
      
      <!-- แหล่งเงินทุน -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center mb-6">
        <input type="checkbox">
        <label class="md:text-right font-medium text-gray-700">
          แหล่งเงินทุนภายนอก
        </label>
        <input type="checkbox">
        <label class="md:text-right font-medium text-gray-700">
          แหล่งเงินทุนภายใน
        </label>
        <input type="date" placeholder="ช่วงเวลา">
      </div>

      <!-- ปีที่วิจัย -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center mb-6">
        <label class="md:text-right font-medium text-gray-700">
          ปีที่วิจัย :
        </label>

        <select
          [(ngModel)]="selectedYear"
          class="md:col-span-3 w-70 border rounded-md px-4 py-2 focus:ring focus:ring-yellow-200"
        >
          <option value="">ทั้งหมด</option>
          <option *ngFor="let y of years" [value]="y">{{ y }}</option>
        </select>
      </div>

      <!-- ชื่อนักวิจัย -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center mb-6">
        <label class="md:text-right font-medium text-gray-700">
          ชื่องานวิจัย :
        </label>

        <input
          [(ngModel)]="researchTitle"
          type="text"
          class="md:col-span-3 w-full border rounded-md px-4 py-2 focus:ring focus:ring-yellow-200"
          placeholder="กรอกชื่อนักวิจัย"
        />
      </div>

      <!-- Buttons -->
      <div class="flex justify-center gap-4 mt-8">
        <button
          (click)="search()"
          class="px-6 py-2 bg-[#FACC15] text-[#1E293B] rounded-lg hover:bg-[#FDE68A] transition cursor-pointer"
        >
          <i class="bi bi-search mr-2"></i>
          ค้นหา
        </button>
      </div>
    </div>

    <!-- ===== DONUT CHART ===== -->
    <div
      *ngIf="isSearched"
      class="max-w-7xl mx-auto mt-8 grid grid-cols-1 md:grid-cols-2 gap-6"
    >
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="font-semibold mb-4">สัดส่วนนักวิจัย จำแนกตามสายงาน</h2>

        <apx-chart
          *ngIf="donutSeries.length > 0; else noData"
          [series]="donutSeries"
          [labels]="donutLabels"
          [chart]="donutChart"
          [legend]="donutLegend"
        ></apx-chart>

        <ng-template #noData>
          <div class="text-center text-gray-400 py-16">ไม่พบข้อมูล</div>
        </ng-template>
      </div>

      <div
        class="bg-white rounded-xl shadow p-6 flex flex-col justify-center items-center"
      >
        <p *ngFor="let l of donutLabels; let i = index">
          {{ l }} : {{ donutSeries[i] }} งาน
        </p>

        <p class="mt-4 text-sm text-gray-500">
          รวมทั้งหมด {{ totalResearchers }} งาน
        </p>
      </div>
    </div>

    <!-- ===== TABLE ===== -->
    <div
      *ngIf="isSearched"
      class="max-w-7xl mx-auto mt-8 bg-white rounded-xl shadow p-6"
    >
      <h2 class="text-xl font-semibold mb-4">
        {{
          selectedType === "project"
            ? "โครงการวิจัย"
            : selectedType === "article"
            ? "บทความ / วารสาร"
            : selectedType === "innovation"
            ? "นวัตกรรมสิ่งประดิษฐ์"
            : "โครงการวิจัย / บทความ / วารสาร / นวัตกรรมสิ่งประดิษฐ์"
        }}
      </h2>

      <div class="overflow-x-auto">
        <table class="w-full border border-gray-300">
          <thead class="bg-[#FACC15]">
            <tr>
              <th class="p-3 border">ลำดับ</th>
              <th class="p-3 border">ชื่อเจ้าของผลงาน</th>
              <th class="p-3 border">ชื่องานวิจัย</th>
              <th class="p-3 border">รายละเอียด</th>
            </tr>
          </thead>

          <tbody>
            <tr
              *ngFor="let r of filteredResearchers; let i = index"
              class="hover:bg-gray-50"
            >
              <td class="p-3 border text-center">{{ i + 1 }}</td>
              <td class="p-3 border">{{ r.name }}</td>
              <td class="p-3 border">{{ r.title }}</td>
              <td class="p-3 border text-center">
                <i
                  (click)="goToResearch(r.id, r.type)"
                  class="bi bi-arrow-right-square text-blue-500 hover:text-blue-700 cursor-pointer"
                ></i>
              </td>
            </tr>

            <tr *ngIf="filteredResearchers.length === 0">
              <td colspan="5" class="p-4 text-center text-gray-500">
                ไม่พบข้อมูล
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
