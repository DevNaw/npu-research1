<div class="bg-gray-100 min-h-screen p-6 text-2xl font-bold text-[#394250]">
  <!-- ===== SEARCH ===== -->
  <div class="max-w-3xl mx-auto md:p-6">
    <!-- Title -->
    <div class="flex flex-col justify-center items-center text-center">
      <div
        class="w-24 h-24 rounded-full bg-linear-to-b from-sky-200 to-sky-100 flex items-center justify-center mb-4"
      >
        <i class="bi bi-search text-4xl"></i>
      </div>
      <h1 class="text-4xl font-bold">ค้นหาข้อมูลงานวิจัย</h1>
    </div>

    <div class="mx-w-full mx-auto mt-4 md:mt-10 md:mb-6">
      <!-- === ตัวกรอง === -->
      <div class="grid grid-cols-12 gap-3 items-center">
        <!-- ===== label ===== -->
        <label
          class="col-span-12 md:col-span-2 text-4xl"
        >
          ตัวกรอง
        </label>

        <!-- ===== เลือกประเภทผลงาน ===== -->
        <div class="col-span-12 md:col-span-5 relative font-medium">
          <button
            type="button"
            (click)="toggleDropdown('type', $event)"
            class="w-full h-11 border border-gray-300 rounded-full px-6 flex justify-between items-center bg-white"
          >
            <span class="truncate">
              {{ displaySelectedType() }}
            </span>
            <i class="bi bi-chevron-down"></i>
          </button>

          <!-- dropdown type -->
          <div
            *ngIf="isOpen('type')"
            class="absolute z-50 w-full bg-white border rounded-md mt-1 shadow"
            (click)="$event.stopPropagation()"
          >
            <input
              [(ngModel)]="searchType"
              placeholder="ค้นหา..."
              class="w-full px-3 py-2 border-b outline-none"
            />
            <ul class="max-h-48 overflow-y-auto">
              <li
                *ngFor="let t of filteredType()"
                (click)="selectType(t)"
                class="px-4 py-2 cursor-pointer hover:bg-gray-100"
              >
                {{ t }}
              </li>
            </ul>
          </div>

          <!-- dropdown subtype -->
          <div
            *ngIf="
              selectedType &&
              subTypeMap[selectedType].length > 0 &&
              isOpen('subType')
            "
            class="absolute z-40 w-full bg-white border rounded-md mt-1 shadow"
            (click)="$event.stopPropagation()"
          >
            <input
              [(ngModel)]="searchSubType"
              placeholder="ค้นหา..."
              class="w-full px-3 py-2 border-b outline-none"
            />
            <ul class="max-h-48 overflow-y-auto">
              <li
                *ngFor="let st of filteredSubType()"
                (click)="selectSubType(st)"
                class="px-4 py-2 cursor-pointer hover:bg-gray-100"
              >
                {{ st }}
              </li>
            </ul>
          </div>
        </div>

        <!-- ===== เลือกหน่วยงาน ===== -->
        <div class="col-span-12 md:col-span-5 relative font-medium">
          <button
            type="button"
            (click)="toggleDropdown('agency', $event)"
            class="w-full h-11 border border-gray-300 rounded-full px-6 flex justify-between items-center bg-white"
          >
            <span class="truncate">
              {{ selectedAgency || "เลือกหน่วยงาน" }}
            </span>
            <i class="bi bi-chevron-down"></i>
          </button>

          <div
            *ngIf="isOpen('agency')"
            class="absolute z-50 w-full bg-white border rounded-md mt-1 shadow"
            (click)="$event.stopPropagation()"
          >
            <input
              [(ngModel)]="searchAgency"
              placeholder="ค้นหา..."
              class="w-full px-3 py-2 border-b outline-none"
            />
            <ul class="max-h-48 overflow-y-auto">
              <li
                *ngFor="let a of filteredAgency()"
                (click)="selectAgency(a)"
                class="px-4 py-2 hover:bg-yellow-50 cursor-pointer"
              >
                {{ a }}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- แหล่งเงินทุน -->
      <div class="grid grid-cols-12 gap-3 items-center mt-4 mb-4">
        <!-- แหล่งเงินทุนภายนอก -->
        <label
          class="col-span-12 md:col-span-4
                 flex items-center gap-3
                 border border-gray-200 rounded-full
                 px-5 h-12 cursor-pointer
                 hover:border-yellow-400 transition"
        >
          <input
            type="checkbox"
            [(ngModel)]="fundingExternal"
            class="w-4 h-4 text-yellow-500
                   border-gray-300 rounded
                   focus:ring-2 focus:ring-yellow-400"
          />
          <span class="font-medium text-gray-700">
            แหล่งเงินทุนภายนอก
          </span>
        </label>
      
        <!-- แหล่งเงินทุนภายใน -->
        <label
          class="col-span-12 md:col-span-4
                 flex items-center gap-3
                 border border-gray-200 rounded-full
                 px-5 h-12 cursor-pointer
                 hover:border-yellow-400 transition"
        >
          <input
            type="checkbox"
            [(ngModel)]="fundingInternal"
            class="w-4 h-4 text-yellow-500
                   border-gray-300 rounded
                   focus:ring-2 focus:ring-yellow-400"
          />
          <span class="font-medium text-gray-700">
            แหล่งเงินทุนภายใน
          </span>
        </label>
      
        <!-- ช่วงเวลา -->
        <div class="col-span-12 md:col-span-4 relative font-medium">
          <!-- icon -->
          <div
            class="absolute inset-y-0 left-0 flex items-center ps-4 pointer-events-none text-gray-500 z-10"
          >
            <i class="bi bi-calendar-event text-lg"></i>
          </div>
      
          <input
            type="text"
            readonly
            (click)="picker.open()"
            [value]="displayRange"
            placeholder="ช่วงเวลา"
            class="block w-full h-12 ps-11 pe-4 text-2xl
                   text-gray-800 bg-white
                   border border-gray-300
                   rounded-full cursor-pointer
                   focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400"
          />
      
          <mat-date-range-picker #picker></mat-date-range-picker>
      
          <mat-date-range-input
            [rangePicker]="picker"
            class="hidden-datepicker"
          >
            <input matStartDate [(ngModel)]="startDate" />
            <input matEndDate [(ngModel)]="endDate" />
          </mat-date-range-input>
        </div>
      </div>
      

      <!-- ===== เลือกสาขาวิชา ===== -->
      <div class="col-span-12 md:col-span-10 relative font-medium">
        <button
          (click)="toggleDropdown('faculties', $event)"
          class="w-full h-11 border rounded-full px-6 flex justify-between items-center bg-white border-gray-300"
        >
          <span class="truncate">{{ selectedFaculty || "เลือกสาขาวิชา" }}</span>
          <i class="bi bi-chevron-down"></i>
        </button>

        <div
          *ngIf="isOpen('faculties')"
          class="absolute z-50 w-full bg-white border rounded-md mt-1 shadow"
          (click)="$event.stopPropagation()"
        >
          <input
            [(ngModel)]="searchFaculitie"
            placeholder="ค้นหา..."
            class="w-full px-3 py-2 border-b outline-none"
          />

          <ul class="max-h-48 overflow-y-auto">
            <li
              *ngFor="let f of filteredFaculties()"
              (click)="selectFaculities(f)"
              class="px-4 py-2 hover:bg-yellow-50 cursor-pointer"
            >
              {{ f }}
            </li>

            <li
              *ngIf="filteredFaculties().length === 0"
              class="px-4 py-2 text-gray-400 text-center"
            >
              ไม่พบข้อมูล
            </li>
          </ul>
        </div>
      </div>

      <!-- ==== Search Box ===== -->
      <div class="flex justify-center mt-6">
        <div
          class="w-full max-w-3xl h-16 flex items-center border border-gray-300 rounded-full overflow-hidden bg-white"
        >
          <input
            [(ngModel)]="researchItems"
            placeholder="พิมพ์คำค้นหา ชื่อเรื่อง/บทความ/นวัตกรรม"
            class="flex-1 px-6 md:px-8 text-2xl outline-none border-none font-semibold"
          />

          <button
            (click)="search()"
            class="flex items-center justify-center h-14 md:h-full bg-yellow-400 hover:bg-yellow-300 px-4 font-semibold md:px-10 rounded-full transition cursor-pointer"
          >
            <span class="hidden md:inline text-2xl mr-4">ค้นหา</span>
            <span
              class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-white"
              ><i class="bi bi-arrow-right"></i
            ></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== DONUT CHART ===== -->
  <div
    *ngIf="isSearched"
    class="mx-auto mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 md:px-10"
  >
    <div class="bg-[#394250] text-white rounded-xl shadow p-6">
      <div class="flex items-center gap-2 mb-4">
        <i class="bi bi-pie-chart-fill text-lg"></i>
        <h2 class="text-2xl md:text-3xl">สัดส่วนนักวิจัย จำแนกตามสาขาวิชา</h2>
      </div>

      <apx-chart
        *ngIf="donutSeries.length > 0; else noData"
        [series]="donutSeries"
        [labels]="donutLabels"
        [chart]="donutChart"
        [legend]="donutLegend"
      ></apx-chart>

      <ng-template #noData>
        <div class="text-center text-red-500 py-16">ไม่พบข้อมูล</div>
      </ng-template>
    </div>

    <div class="bg-white rounded-xl shadow p-6 flex flex-col justify-between gap-4">
      <!-- Header -->
      <div class="flex items-center gap-2">
        <i class="bi bi-pie-chart-fill text-xl text-[#394250]"></i>
        <h2 class="text-2xl md:text-3xl font-bold text-[#394250]">
          สัดส่วนนักวิจัย จำแนกตามสาขาวิชา
        </h2>
      </div>
    
      <!-- List -->
      <div class="space-y-2 text-[#394250] px-8">
        <p
          *ngFor="let l of donutLabels; let i = index"
          class="flex justify-between border-b last:border-b-0 pb-1"
        >
          <span class="font-medium">{{ l }}</span>
          <span class="font-medium">{{ donutSeries[i] }} งาน</span>
        </p>
      </div>
    
      <!-- Footer -->
      <div class="pt-3 border-t">
        <p class="text-4xl text-center font-bold text-[#394250]">
          รวมทั้งหมด {{ totalResearchers }} งาน
        </p>
      </div>
    </div>
    
  </div>
</div>

<!-- ===== TABLE ===== -->
<div *ngIf="isSearched" class="bg-[#F9CB34] md:py-6 md:px-10 text-2xl">
  <div class="mx-auto p-6 md:px-6">
    <div
      class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-2 md:mb-4"
    >
      <h2 class="text-2xl md:text-3xl font-bold">
        {{
          selectedType === "project"
            ? "โครงการวิจัย"
            : selectedType === "article"
            ? "บทความ / วารสาร"
            : selectedType === "innovation"
            ? "นวัตกรรมสิ่งประดิษฐ์"
            : "โครงการวิจัย / บทความ / วารสาร / นวัตกรรมสิ่งประดิษฐ์"
        }}
      </h2>
      <div class="flex items-center justify-end">
        <span class="font-bold mr-2">Search:</span>
        <input
          [(ngModel)]="searchText"
          (input)="onSearch()"
          class="border h-10 bg-white rounded-md shadow p-4 md:p-3"
          placeholder="ค้นหา..."
        />
      </div>
    </div>
    <div class="bg-white rounded-xl shadow p-4 md:p-8">
      <div class="overflow-x-auto">
        <table class="w-full border border-gray-300">
          <thead class="bg-[#394250] text-white border-b-2 border-gray-300">
            <tr>
              <th class="p-1 md:p-2">#</th>
              <th class="p-1 md:p-2 text-start">ชื่อเจ้าของผลงาน</th>
              <th class="p-1 md:p-2 text-start">ชื่องานวิจัย</th>
              <th class="p-1 md:p-2">รายละเอียด</th>
            </tr>
          </thead>

          <tbody>
            <tr
              *ngFor="let r of filteredResearchers; let i = index"
              class="hover:bg-gray-50 bg-gray-200 border-b border-gray-300"
            >
              <td class="p-1 md:p-2 text-center">{{ i + 1 }}</td>
              <td class="p-1 md:p-2">{{ r.name }}</td>
              <td class="p-1 md:p-2">{{ r.title }}</td>
              <td class="p-1 md:p-2 text-center">
                <i
                  (click)="goToResearch(r.id, r.type)"
                  class="bi bi-arrow-right-square text-blue-500 hover:text-blue-700 cursor-pointer"
                ></i>
              </td>
            </tr>

            <tr *ngIf="filteredResearchers.length === 0">
              <td colspan="5" class="p-4 text-center text-gray-500 font-bold">
                ไม่พบข้อมูล
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div
    class="flex flex-col md:flex-row md:justify-end md:items-center mt-4 gap-2"
  >
    <div class="flex items-center justify-end space-x-1">
      <!-- Prev -->
      <button
        (click)="changePage(currentPage - 1)"
        [disabled]="currentPage === 1"
        class="px-2 md:px-3 py-1 rounded border text-sm disabled:opacity-40 hover:bg-gray-100 cursor-pointer"
      >
        ‹
      </button>

      <!-- Pages -->
      <button
        *ngFor="let page of pages"
        (click)="changePage(page)"
        class="px-2 md:px-3 py-1 rounded border text-sm transition"
        [ngClass]="{
          'bg-[#FACC15] text-[#1E293B] font-semibold':
            currentPage === page,
          'hover:bg-gray-100': currentPage !== page
        }"
      >
        {{ page }}
      </button>

      <!-- Next -->
      <button
        (click)="changePage(currentPage + 1)"
        [disabled]="currentPage === totalPages"
        class="px-2 md:px-3 py-1 rounded border text-sm disabled:opacity-40 hover:bg-gray-100 cursor-pointer"
      >
        ›
      </button>
    </div>
  </div>
    </div>
  </div>
</div>
